defaults:
  image: &image
    docker:
      - image: circleci/node
  yarn_cache: &yarn_cache
    key: yarn_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ checksum "yarn.lock" }}
  build_final_cache_partial: &build_final_cache_partial
    key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-all-
  archive_build: &archive_build
    name: Archive build
    command: tar cvf ../build.tar packages/@storefront/*/{dist,esnext}
  extract_build_archive: &extract_build_archive
    name: Extract archive
    command: |
      [[ ! -r ../build.tar ]] || tar xvf ../build.tar

  yarn_install: &yarn_install
    name: Install
    command: yarn
  setup_git: &setup_git
    name: Setup Git user
    command: |
      git config --global user.email "ops@groupbyinc.com"
      git config --global user.name "GroupBy Ops"
      git config --global push.default simple

  requires_build_structure: &requires_build_structure
    requires:
      - build_structure
  requires_build: &requires_build
    requires:
      - build_final

  run_release_script: &run_release_script
    name: Run release script
    command: |
      package="${CIRCLE_JOB#release_}"
      package="${package//_/-}"
      branch_prefix="$(cat ../branch-name)"

      git checkout "${branch_prefix}/${package}"

      cd "packages/@storefront/${package}"

      touch ~/releases

      if ../../../scripts/release.sh -o ~/releases; then
        exit_code=0
      elif ec=$?; (( ec == 4 )); then
        exit_code=0
      else
        exit_code=$ec
      fi

      exit $exit_code

version: 2.1

jobs:
  generate_cache_key_file:
    <<: *image
    working_directory: ~/
    steps:
      - run: date +%s > workflow-start
      - persist_to_workspace:
          root: ~/
          paths:
            - workflow-start

  build:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - restore_cache:
          <<: *yarn_cache
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-
      - run: *extract_build_archive
      - run:
          name: Dependencies
          command: sudo apt install -y rsync
      - run:
          <<: *yarn_install
      - save_cache:
          <<: *yarn_cache
          paths:
            - ~/.cache/yarn
      - run:
          name: Build
          command: |
            package="${CIRCLE_JOB#build_}"
            package="${package//_/-}"

            cd "packages/@storefront/${package}"
            yarn build
      - run: *archive_build
      - save_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-{{ .Environment.CIRCLE_JOB }}-{{ epoch }}
          paths:
            - ~/build.tar
  build_final:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_breadcrumbs-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_collections-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_core-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_details-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_did_you_mean-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_flux_capacitor-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_infinite_scroll-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_navigation-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_page_size-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_paging-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_products-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_query-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_recommendations-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_record_count-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_related_queries-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_sayt-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_sort-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_structure-
      - run: *extract_build_archive
      - restore_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-build_template-
      - run: *extract_build_archive
      - run: *archive_build
      - save_cache:
          key: build_cache-v{{ .Environment.CI_CACHE_VERSION }}-{{ .Branch }}-{{ .Revision }}-{{ checksum "../workflow-start" }}-all-{{ epoch }}
          paths:
            - ~/build.tar
      - save_cache:
          <<: *yarn_cache
          paths:
            - ~/.cache/yarn

  unit_test:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - restore_cache:
          <<: *yarn_cache
      - restore_cache: *build_final_cache_partial
      - run: *extract_build_archive
      - run:
          <<: *yarn_install
      - run:
          name: Test
          command: |
            package="${CIRCLE_JOB#unit_test_}"
            package="${package//_/-}"

            cd "packages/@storefront/${package}"
            yarn test
      - run:
          name: Upload coverage
          command: |
            package="${CIRCLE_JOB#unit_test_}"
            package="${package//_/-}"

            cd "packages/@storefront/${package}"
            yarn uploadCoverage
  unit_test_final:
    <<: *image
    steps:
      - run: exit 0

  setup_release_branch:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run:
          name: Compute branch name
          command: echo "release/$(cat ../workflow-start)" > ../branch-name
      - run:
          name: Create branch
          command: git checkout -b "$(cat ../branch-name)/master"
      - run:
          name: Push branch
          command: git push -u origin HEAD
      - persist_to_workspace:
          root: ~/
          paths:
            - branch-name

  setup_package_branch:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run:
          name: Create branch
          command:
            package="${CIRCLE_JOB#setup_package_branch_}"
            package="${package//_/-}"
            branch_prefix="$(cat ../branch-name)"

            git checkout -b "${branch_prefix}/${package}" "origin/${branch_prefix}/master"
      - run:
          name: Push branch
          command: git push -u origin HEAD

  docs:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - restore_cache:
          <<: *yarn_cache
      - restore_cache: *build_final_cache_partial
      - run: *extract_build_archive
      - run:
          <<: *yarn_install
      - run: *setup_git
      - run:
          name: Checkout release branch
          command:  git checkout "$(cat ../branch-name)/master"
      - run:
          name: Docs
          command: yarn docs
      - run:
          name: Commit
          command: |
            git add docs
            git commit -m "Generate docs" -m "[ci skip]"
      - run:
          name: Push
          command: git push -u origin HEAD

  bump_dependency:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run: *setup_git
      - run:
          name: Checkout release branch
          command:  git checkout "$(cat ../branch-name)/master"
      - run:
          name: Install dependencies
          command: sudo apt install -y ed
      - run:
          name: Run release script
          # TODO: Maybe add the version number in commit
          command: |
            package="${CIRCLE_JOB#bump_dependency_}"
            src="${package%%__*}"
            src="${src//_/-}"
            target="${package##*__}"
            target="${target//_/-}"

            version="$({ grep -F "$src" ~/releases || true; } | cut -d ' ' -f 2)"
            release_type="$({ grep -F "$src" ~/releases || true; } | cut -d ' ' -f 3)"

            if [[ -n "$release_type" ]]; then
              ./scripts/update-dependency.sh -n "$version" "$src" "$release_type" "$target"

              git commit -am "Bump ${src} dependency in ${target} to ${version}"
              git push -u origin HEAD
            else
              echo "Nothing to bump."
            fi

  release_base:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - restore_cache:
          <<: *yarn_cache
      - restore_cache: *build_final_cache_partial
      - run: *extract_build_archive
      - run:
          <<: *yarn_install
      - run: *setup_git
      - run:
          name: Install dependencies
          command: sudo apt install -y ed
      - run: *run_release_script
      - persist_to_workspace:
          root: ~/
          paths:
            - releases

  release_components:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - restore_cache:
          <<: *yarn_cache
      - restore_cache: *build_final_cache_partial
      - run: *extract_build_archive
      - run:
          <<: *yarn_install
      - run: *setup_git
      - run:
          name: Install dependencies
          command: sudo apt install -y ed
      - run: *run_release_script

  merge_base:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run: *setup_git
      - run:
          name: Merge into release branch
          command: |
            package="${CIRCLE_JOB#merge_}"
            package="${package//_/-}"
            branch_prefix="$(cat ../branch-name)"

            git checkout "${branch_prefix}/master"
            git merge "origin/${branch_prefix}/${package}"
            git push -u origin HEAD

  merge_components:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run: *setup_git
      - run:
          name: Merge into release branch
          command: |
            branch_prefix="$(cat ../branch-name)"

            git checkout "${branch_prefix}/master"
            find packages/@storefront/ -mindepth 1 -maxdepth 1 -type d |
              sed 's#^packages/@storefront#'"origin/${branch_prefix}"'#' |
              sort |
              xargs git merge -m "Merge component release branches"
            git push -u origin HEAD

  merge_final:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run: *setup_git
      - run:
          name: Merge into source branch
          command: |
            release_branch="$(cat ../branch-name)/master"

            git checkout "$CIRCLE_BRANCH"
            git pull origin "$CIRCLE_BRANCH"

            # create a local branch first so the message is nicer
            git fetch origin "${release_branch}:${release_branch}"

            git merge --no-ff --no-edit "$release_branch"

            git push -u origin HEAD

  publish:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - restore_cache: *build_final_cache_partial
      - run: *extract_build_archive
      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
      - run:
          name: Publish
          command: |
            package="${CIRCLE_JOB#publish_}"
            package="${package//_/-}"
            branch_prefix="$(cat ../branch-name)"

            git checkout "${branch_prefix}/${package}"

            cd "packages/@storefront/${package}"

            if grep -q -F "$package" ~/releases; then
              ../../../scripts/publish.sh -t tmp
            else
              echo "Nothing to publish."
            fi

  cleanup:
    <<: *image
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run: *setup_git
      - run:
          name: Delete release branches
          command: git branch -r --list "origin/$(cat ../branch-name)/*" | xargs git push --delete

workflows:
  version: 2

  build_test_release:
    jobs:
      - generate_cache_key_file:
          filters:
            branches:
              ignore: /release\/.*/
      - build:
          name: build_flux_capacitor
          requires:
            - generate_cache_key_file
      - build:
          name: build_core
          requires:
            - build_flux_capacitor
      - build:
          name: build_structure
          requires:
            - build_core
      - build:
          name: build_breadcrumbs
          <<: *requires_build_structure
      - build:
          name: build_collections
          <<: *requires_build_structure
      - build:
          name: build_details
          <<: *requires_build_structure
      - build:
          name: build_did_you_mean
          <<: *requires_build_structure
      - build:
          name: build_infinite_scroll
          <<: *requires_build_structure
      - build:
          name: build_navigation
          <<: *requires_build_structure
      - build:
          name: build_page_size
          <<: *requires_build_structure
      - build:
          name: build_paging
          <<: *requires_build_structure
      - build:
          name: build_products
          <<: *requires_build_structure
      - build:
          name: build_query
          <<: *requires_build_structure
      - build:
          name: build_recommendations
          <<: *requires_build_structure
      - build:
          name: build_record_count
          <<: *requires_build_structure
      - build:
          name: build_related_queries
          <<: *requires_build_structure
      - build:
          name: build_sayt
          <<: *requires_build_structure
      - build:
          name: build_sort
          <<: *requires_build_structure
      - build:
          name: build_template
          <<: *requires_build_structure
      - build_final:
          requires:
            - build_flux_capacitor
            - build_core
            - build_structure
            - build_breadcrumbs
            - build_collections
            - build_details
            - build_did_you_mean
            - build_infinite_scroll
            - build_navigation
            - build_page_size
            - build_paging
            - build_products
            - build_query
            - build_recommendations
            - build_record_count
            - build_related_queries
            - build_sayt
            - build_sort
            - build_template

      - unit_test:
          name: unit_test_flux_capacitor
          <<: *requires_build
      - unit_test:
          name: unit_test_core
          <<: *requires_build
      - unit_test:
          name: unit_test_structure
          <<: *requires_build
      - unit_test:
          name: unit_test_breadcrumbs
          <<: *requires_build
      - unit_test:
          name: unit_test_collections
          <<: *requires_build
      - unit_test:
          name: unit_test_details
          <<: *requires_build
      - unit_test:
          name: unit_test_did_you_mean
          <<: *requires_build
      - unit_test:
          name: unit_test_infinite_scroll
          <<: *requires_build
      - unit_test:
          name: unit_test_navigation
          <<: *requires_build
      - unit_test:
          name: unit_test_page_size
          <<: *requires_build
      - unit_test:
          name: unit_test_paging
          <<: *requires_build
      - unit_test:
          name: unit_test_products
          <<: *requires_build
      - unit_test:
          name: unit_test_query
          <<: *requires_build
      - unit_test:
          name: unit_test_recommendations
          <<: *requires_build
      - unit_test:
          name: unit_test_record_count
          <<: *requires_build
      - unit_test:
          name: unit_test_related_queries
          <<: *requires_build
      - unit_test:
          name: unit_test_sayt
          <<: *requires_build
      - unit_test:
          name: unit_test_sort
          <<: *requires_build
      - unit_test:
          name: unit_test_template
          <<: *requires_build
      - unit_test_final:
          requires:
            - unit_test_flux_capacitor
            - unit_test_core
            - unit_test_structure
            - unit_test_breadcrumbs
            - unit_test_collections
            - unit_test_details
            - unit_test_did_you_mean
            - unit_test_infinite_scroll
            - unit_test_navigation
            - unit_test_page_size
            - unit_test_paging
            - unit_test_products
            - unit_test_query
            - unit_test_recommendations
            - unit_test_record_count
            - unit_test_related_queries
            - unit_test_sayt
            - unit_test_sort
            - unit_test_template

      - setup_release_branch:
          requires:
            - unit_test_final
          filters:
            branches:
              only:
                - master
                - /SF-1143(-.*)?/

      - docs:
          requires:
            - setup_release_branch

      # flux-capacitor
      - setup_package_branch:
          name: setup_package_branch_flux_capacitor
          requires:
            - docs
      - release_base:
          name: release_flux_capacitor
          requires:
            - setup_package_branch_flux_capacitor
      - merge_base:
          name: merge_flux_capacitor
          requires:
            - release_flux_capacitor
      - publish:
          name: publish_flux_capacitor
          context: org-global
          requires:
            - merge_flux_capacitor

      # core
      - setup_package_branch:
          name: setup_package_branch_core
          requires:
            - publish_flux_capacitor
      - bump_dependency:
          name: bump_dependency_flux_capacitor__core
          requires:
            - setup_package_branch_core
      - release_base:
          name: release_core
          requires:
            - bump_dependency_flux_capacitor__core
      - merge_base:
          name: merge_core
          requires:
            - release_core
      - publish:
          name: publish_core
          context: org-global
          requires:
            - merge_core

      # structure
      - setup_package_branch:
          name: setup_package_branch_structure
          requires:
            - publish_core
      - bump_dependency:
          name: bump_dependency_core__structure
          requires:
            - setup_package_branch_structure
      - release_base:
          name: release_structure
          requires:
            - bump_dependency_core__structure
      - merge_base:
          name: merge_structure
          requires:
            - release_structure
      - publish:
          name: publish_structure
          context: org-global
          requires:
            - merge_structure

      # breadcrumbs
      - setup_package_branch:
          name: setup_package_branch_breadcrumbs
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__breadcrumbs
          requires:
            - setup_package_branch_breadcrumbs
      - release_components:
          name: release_breadcrumbs
          requires:
            - bump_dependency_core__breadcrumbs
      - publish:
          name: publish_breadcrumbs
          context: org-global
          requires:
            - release_breadcrumbs

      # collections
      - setup_package_branch:
          name: setup_package_branch_collections
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__collections
          requires:
            - setup_package_branch_collections
      - release_components:
          name: release_collections
          requires:
            - bump_dependency_core__collections
      - publish:
          name: publish_collections
          context: org-global
          requires:
            - release_collections

      # details
      - setup_package_branch:
          name: setup_package_branch_details
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__details
          requires:
            - setup_package_branch_details
      - release_components:
          name: release_details
          requires:
            - bump_dependency_core__details
      - publish:
          name: publish_details
          context: org-global
          requires:
            - release_details

      # did-you-mean
      - setup_package_branch:
          name: setup_package_branch_did_you_mean
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__did_you_mean
          requires:
            - setup_package_branch_did_you_mean
      - release_components:
          name: release_did_you_mean
          requires:
            - bump_dependency_core__did_you_mean
      - publish:
          name: publish_did_you_mean
          context: org-global
          requires:
            - release_did_you_mean

      # infinite-scroll
      - setup_package_branch:
          name: setup_package_branch_infinite_scroll
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__infinite_scroll
          requires:
            - setup_package_branch_infinite_scroll
      - bump_dependency:
          name: bump_dependency_structure__infinite_scroll
          requires:
            - bump_dependency_core__infinite_scroll
      - release_components:
          name: release_infinite_scroll
          requires:
            - bump_dependency_structure__infinite_scroll
      - publish:
          name: publish_infinite_scroll
          context: org-global
          requires:
            - release_infinite_scroll

      # navigation
      - setup_package_branch:
          name: setup_package_branch_navigation
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__navigation
          requires:
            - setup_package_branch_navigation
      - bump_dependency:
          name: bump_dependency_structure__navigation
          requires:
            - bump_dependency_core__navigation
      - release_components:
          name: release_navigation
          requires:
            - bump_dependency_structure__navigation
      - publish:
          name: publish_navigation
          context: org-global
          requires:
            - release_navigation

      # page-size
      - setup_package_branch:
          name: setup_package_branch_page_size
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__page_size
          requires:
            - setup_package_branch_page_size
      - release_components:
          name: release_page_size
          requires:
            - bump_dependency_core__page_size
      - publish:
          name: publish_page_size
          context: org-global
          requires:
            - release_page_size

      # paging
      - setup_package_branch:
          name: setup_package_branch_paging
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__paging
          requires:
            - setup_package_branch_paging
      - release_components:
          name: release_paging
          requires:
            - bump_dependency_core__paging
      - publish:
          name: publish_paging
          context: org-global
          requires:
            - release_paging

      # products
      - setup_package_branch:
          name: setup_package_branch_products
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__products
          requires:
            - setup_package_branch_products
      - release_components:
          name: release_products
          requires:
            - bump_dependency_core__products
      - publish:
          name: publish_products
          context: org-global
          requires:
            - release_products

      # query
      - setup_package_branch:
          name: setup_package_branch_query
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__query
          requires:
            - setup_package_branch_query
      - release_components:
          name: release_query
          requires:
            - bump_dependency_core__query
      - publish:
          name: publish_query
          context: org-global
          requires:
            - release_query

      # recommendations
      - setup_package_branch:
          name: setup_package_branch_recommendations
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__recommendations
          requires:
            - setup_package_branch_recommendations
      - release_components:
          name: release_recommendations
          requires:
            - bump_dependency_core__recommendations
      - publish:
          name: publish_recommendations
          context: org-global
          requires:
            - release_recommendations

      # record-count
      - setup_package_branch:
          name: setup_package_branch_record_count
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__record_count
          requires:
            - setup_package_branch_record_count
      - release_components:
          name: release_record_count
          requires:
            - bump_dependency_core__record_count
      - publish:
          name: publish_record_count
          context: org-global
          requires:
            - release_record_count

      # related-queries
      - setup_package_branch:
          name: setup_package_branch_related_queries
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__related_queries
          requires:
            - setup_package_branch_related_queries
      - release_components:
          name: release_related_queries
          requires:
            - bump_dependency_core__related_queries
      - publish:
          name: publish_related_queries
          context: org-global
          requires:
            - release_related_queries

      # sayt
      - setup_package_branch:
          name: setup_package_branch_sayt
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__sayt
          requires:
            - setup_package_branch_sayt
      - release_components:
          name: release_sayt
          requires:
            - bump_dependency_core__sayt
      - publish:
          name: publish_sayt
          context: org-global
          requires:
            - release_sayt

      # sort
      - setup_package_branch:
          name: setup_package_branch_sort
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__sort
          requires:
            - setup_package_branch_sort
      - release_components:
          name: release_sort
          requires:
            - bump_dependency_core__sort
      - publish:
          name: publish_sort
          context: org-global
          requires:
            - release_sort

      # template
      - setup_package_branch:
          name: setup_package_branch_template
          requires:
            - publish_structure
      - bump_dependency:
          name: bump_dependency_core__template
          requires:
            - setup_package_branch_template
      - release_components:
          name: release_template
          requires:
            - bump_dependency_core__template
      - publish:
          name: publish_template
          context: org-global
          requires:
            - release_template

      - merge_components:
          requires:
            - publish_breadcrumbs
            - publish_collections
            - publish_details
            - publish_did_you_mean
            - publish_infinite_scroll
            - publish_navigation
            - publish_page_size
            - publish_paging
            - publish_products
            - publish_query
            - publish_recommendations
            - publish_record_count
            - publish_related_queries
            - publish_sayt
            - publish_sort
            - publish_template

      - merge_final:
          requires:
            - merge_components

      - cleanup:
          requires:
            - merge_final
